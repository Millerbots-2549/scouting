<!DOCTYPE html>
<html lang="en">
<head>
    <title>Scouting Results</title>
    <meta charset="utf-8" content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="css/fontawesome-all.min.css" rel="stylesheet" type="text/css"/>
    <link href="css/millerbots.css" rel="stylesheet" type="text/css"/>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/popper.min.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js" type="text/javascript"></script>
</head>
<body>

<div class="jumbotron text-center">
    <div class="container">
        <img alt="" id="millerbots-logo" src="images/miller_bots.jpg"/>
        <h1>Washburn Millerbots Scouting System</h1>
        <p>Team 2549</p>
    </div>
    <nav class="navbar navbar-expand-sm bg-light navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="scouting.html">Scouting</a></li>
        </ul>
    </nav>
    <p></p>
</div>

<div class="container-fluid">
    <div class="" id="event_info">
        <div class="row">
            <div class="col-sm-6">
                <div class="d-flex flex-column">
                    <label for="event_name">Event Name:</label>
                    <select id="event_name" name="eventId"></select>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="d-flex flex-column">
                    <label for="team_number">Team:</label>
                    <select id="team_number" name="teamId"></select>
                </div>
            </div>

        </div>
    </div>

    <div id="resultsDiv"></div>

</div>

<script type="text/javascript">

    var eventId;
    var teamId;

    $.ajax(
        {
            type: "GET",
            url: "results/events",
            dataType: "json",
            success: function (events) {
                buildEvent(events);
            },
            error: function (response) {
                console.log(response);
            }
        });


    $('#event_name').on('change', function () {
        eventId = $(this).val();
        $.ajax(
            {
                type: "GET",
                url: "results/events/" + eventId + "/teams",
                dataType: "json",
                success: function (teams) {
                    $('#resultsDiv').html('');
                    buildTeamList(teams);
                },
                error: function (response) {
                    console.log(response);
                }
            });
    });

    $('#team_number').on('change', function () {
        teamId = $(this).val();
        $.ajax(
            {
                type: "GET",
                url: "results/events/" + eventId + "/teams/" + teamId,
                dataType: "json",
                cache: false,
                success: function (json) {
                    var allSurveyData = '';
                    var surveyObjs = json.surveys;
                    if (surveyObjs === undefined || surveyObjs.length === 0) {
                        allSurveyData += '<hr><h4>No Data Found</h4>';
                    } else {
                        for (i in surveyObjs) {
                            var survey = surveyObjs[i];
                            allSurveyData += buildSurveySection(survey)
                        }
                    }

                    $('#resultsDiv').html(allSurveyData);
                },
                error: function (response) {
                    console.log(response);
                }
            });
    });

    function buildSurveySection(survey) {
        var surveyHtml = '';
        surveyHtml += '<hr><h2>' + survey.surveyName + '</h2><table id="surveyResults' + survey.surveyId + '" class="table-responsive table-bordered">';
        surveyHtml += buildTableHeader(survey.questions);
        surveyHtml += buildTableBody(survey.questions);
        surveyHtml += '</table>';
        return surveyHtml
    }

    function buildTableHeader(questions) {
        var surveyHtml = '<thead>';
        surveyHtml += buildHeaderRow(questions[0]);
        surveyHtml += '</thead>';
        return surveyHtml;
    }

    function buildTableBody(questions) {
        var surveyHtml = '<tbody>';
        surveyHtml += buildStudentNameRow(questions[0]);
        for (i in questions) {
            surveyHtml += buildRow(questions[i])
        }
        surveyHtml += '</tbody>';
        return surveyHtml;
    }

    function buildHeaderRow(question) {
        var responses = question.responses;
        var rowHtml = '<tr>';
        rowHtml += '<th>Question</th>';
        for (i in responses) {
            rowHtml += '<th>Match ' + responses[i].matchup + '</th>';
        }
        rowHtml += '<th>Summary</th>';
        rowHtml += '</tr>';
        return rowHtml;
    }

    function buildStudentNameRow(question) {
        var responses = question.responses;
        var rowHtml = '<tr>';
        rowHtml += '<td><I>Student</I></td>';
        for (i in responses) {
            rowHtml += '<td><I>' + responses[i].studentName + '</I></td>';
        }
        rowHtml += '<td></td>';
        rowHtml += '</tr>';
        return rowHtml;
    }

    function buildRow(question) {
        var responses = question.responses;
        var rowHtml = '<tr>';
        rowHtml += '<td>' + question.question + '</td>';
        for (i in responses) {
            rowHtml += '<td>' + responses[i].response + '</td>';
        }
        rowHtml += '<td>' + question.summary + '</td>';
        rowHtml += '</tr>';
        return rowHtml;
    }

    function buildEvent(eventsObj) {
        var eventOptions = '<option value="-1"></option>';

        for (i in eventsObj) {
            var event = eventsObj[i];
            eventOptions += '<option value="' + event.eventId + '">' + event.city + ' - ' + event.name + '</option>';
        }

        $('#event_name').html(eventOptions);
    }

    function buildTeamList(teamObjs) {
        var teamOptions = '<option value="-1"></option>';

        for (i in teamObjs) {
            var team = teamObjs[i];
            var selection = '[' + team.teamId + '] ' + team.name;
            teamOptions += '<option value="' + team.teamId + '">' + selection + '</option>';
        }

        $('#team_number').html(teamOptions);
    }

</script>

</body>
</html>
